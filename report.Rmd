---
title: "Evaluation of Bivalirudin's Effect on the INR"
author: "Andrea Fetea, Brian Gulbis, Andrea C. Hall"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document: 
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_float: yes
---
```{r global_options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r library}
library(BGTools)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(grid)
library(gridExtra)
library(RColorBrewer)
library(pander)
library(captioner)
panderOptions("table.split.table", Inf)
fig_nums <- captioner()
```

```{r data, echo=FALSE}
tmp <- get_rds("Analysis")
```

## Results

### Demographics
```{r demographics}
x <- result_table("table", analyze.demographics, group = NULL)
pander(x)
```

### Comorbidities
```{r pmh}
x <- result_table("table", analyze.diagnosis, group = NULL)
pander(x)
```

### Anticoagulation Indications
```{r indications}
x <- result_table("table", analyze.indications, group = NULL)
pander(x)
```

### Bleeding and Thrombosis
```{r events}
x <- result_table("table", analyze.bleed, group = NULL)
pander(x)
```

### Baseline Labs
```{r labs}
x <- result_table("table", analyze.labs, group = NULL)
pander(x)
```

### Percent PTT Values
```{r percent_tx}
x <- result_table("table", analyze.ptt.perc, group = NULL)
pander(x)
```

### Bivalirudin Infusion
```{r bival}
x <- result_table("table", analyze.bival, group = NULL)
pander(x)
```

### Medications During Hospitalization
```{r meds}
x <- result_table("table", analyze.meds, group = NULL)
pander(x)
```

### Blood Products
```{r prbc}
x <- result_table("table", analyze.prbc, group = NULL)
pander(x)
```

### Reversal Agents
```{r reversal}
x <- result_table("table", analyze.reversal, group = NULL)
pander(x)
```

### Primary and Secondary Endpoints
```{r endpoints}
x <- result_table("table", analyze.coags, group = NULL)
pander(x)
```

## Figures
```{r fig_caps, echo=FALSE}
fig_nums(name = "inr_tx_ptt", caption = "INR Value at Baseline and Time of First Therapeutic aPTT", display = FALSE)
fig_nums(name = "inr_bival_stop", caption = "INR Value Prior to and 4 to 8 hours After Bivalirudin Cessation", display = FALSE)
fig_nums(name = "inr_chg_bival_start", caption = "Change in INR values at bivalirudin initiation", display = FALSE)
fig_nums(name = "inr_chg_bival_stop", caption = "Change in INR values at bivalirudin cessation", display = FALSE)
fig_nums(name = "dual_bival", caption = "Change in INR and aPTT values at bivalirudin initiation and cessation", display = FALSE)
fig_nums(name = "inr_chg_all", caption = "Change in INR relative to bivalirudin initiation over 10 days", display = FALSE)
fig_nums(name = "ptt_chg_all", caption = "Change in aPTT relative to bivalirudin cessation", display = FALSE)
fig_nums(name = "inr_warfarin", caption = "Change in INR relative to warfarin initiation", display = FALSE)
```

```{r plot_params}
diff.units <- "days"
diff <- if(diff.units == "days") days else if (diff.units == "hours") hours
from = -2
to = 3
by = 1
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)
xlab.start <- paste0("Time from bivalirudin initiation (", diff.units, ")")
xlab.stop <- paste0("Time from bivalirudin cessation (", diff.units, ")")
ylab.inr <- "INR"
ylab.ptt <- "aPTT (seconds)"
ylim.inr <- c(1, 3.5)
ylim.ptt <- c(45, 85)
shapes <- c(20, 21)
shapes.limits <- c(FALSE, TRUE)
graph.alpha <- 0.5
```


```{r echo=FALSE}
cap <- "inr_tx_ptt"
fig_cap <- fig_nums(cap)
```

### `r fig_nums(cap, display = "cite")`
```{r inr_tx_ptt}
results <- select(analyze.coags, pie.id, inr.before, inr.txptt) %>%
    rename(inr1 = inr.before,
           inr2 = inr.txptt) %>%
    group_by(pie.id) %>%
    filter(!is.na(inr1),
           !is.na(inr2)) %>%
    gather(period, inr, inr1, inr2)

cols <- colorRampPalette(brewer.pal(8, "Set1"))
num.cols <- nrow(select(results, pie.id) %>% distinct)

graph <- ggplot(data = results, aes(x = period, y = inr, group = factor(pie.id))) +
    geom_line(size = 1, aes(colour = pie.id)) +
    geom_point(size = 5, pch = 21, fill = "salmon", alpha = 0.5) +
    ggtitle(fig_cap) +
    xlab(NULL) +
    ylab(ylab.inr) +
    scale_x_discrete(labels = c("Baseline", "First Therapeutic aPTT"), expand = c(0.25, 0.25)) +
    scale_color_manual(values = cols(num.cols)) +
    # theme_bw() +
    theme(legend.position = "none")
    # theme(legend.position = "none", plot.title = element_text(size = 20), 
    #       axis.title = element_text(size = 18), axis.text = element_text(size = 16))

print(graph)
```

```{r echo=FALSE}
cap <- "inr_bival_stop"
fig_cap <- fig_nums(cap)
```

### `r fig_nums(cap, display = "cite")`
```{r inr_bival_stop}
results <- select(analyze.coags, pie.id, inr.before.stop, inr.after.stop) %>%
    rename(inr1 = inr.before.stop,
           inr2 = inr.after.stop) %>%
    group_by(pie.id) %>%
    filter(!is.na(inr1),
           !is.na(inr2)) %>%
    gather(period, inr, inr1, inr2)

graph <- ggplot(data = results, aes(x = period, y = inr, group=factor(pie.id))) +
    geom_line(size = 1, aes(colour = pie.id)) +
    geom_point(size = 5, pch = 21, fill = "salmon", alpha = 0.5) +
    ggtitle(fig_cap) +
    xlab(NULL) +
    ylab(ylab.inr) +
    scale_x_discrete(labels = c("Prior to Cessation", "After Cessation"), expand = c(0.25, 0.25)) +
    # theme_bw() +
    theme(legend.position = "none")
    # theme(legend.position = "none", plot.title = element_text(size = 20), 
    #       axis.title = element_text(size = 18), axis.text = element_text(size = 16))

print(graph)
```

```{r echo=FALSE}
cap <- "inr_chg_bival_start"
fig_cap <- fig_nums(cap)
```

### `r fig_nums(cap, display = "cite")`
```{r inr_chg_bival_start}
graph <- analyze.labs.serial %>%
    filter(lab == "inr",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start + diff(from),
           lab.datetime <= bival.start + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = diff.units))) %>%
    ggplot(aes(x = bival.diff, y = result, color = pie.id)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(alpha = graph.alpha) +
    geom_line(alpha = graph.alpha) +
    geom_smooth(aes(group = NULL), color = "blue", se = FALSE) +
    geom_smooth(aes(group = bival.diff <= 0), method = "lm", color = "black") +
    ggtitle(fig_cap) +
    xlab(xlab.start) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    theme(legend.position = "none")

print(graph)
```

Figure `r fig_nums(cap, display = "num")` is depicting the mean INR value before and after bivalirudin initation (represented by the time point 0 on the x-axis). The blue line represents the smoothed mean INR value throughout the time period. The black line represents the linear mean INR value, split for values before initiation and after initiation. The colored lines and points represent individual patient INR values. Data from patients who started warfarin during the first 24 hours after bivalirudin initiation were excluded, so the INR increase during the first 24 hours of bivalirudin infusion should be the result of bivalirudin.

```{r echo=FALSE}
cap <- "inr_chg_bival_stop"
fig_cap <- fig_nums(cap)
```

### `r fig_nums(cap, display = "cite")`
```{r inr_chg_bival_stop}
graph <- analyze.labs.serial %>%
    filter(lab == "inr",
           last(lab.datetime) > bival.stop,
           lab.datetime >= bival.stop + diff(from),
           lab.datetime <= bival.stop + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.stop, units = diff.units))) %>%
    ggplot(aes(x = bival.diff, y = result, color = pie.id)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(alpha = graph.alpha) +
    geom_line(alpha = graph.alpha) +
    geom_smooth(aes(group = NULL), color = "blue", se = FALSE) +
    geom_smooth(aes(group = bival.diff <= 0), method = "lm", color = "black") +
    ggtitle(fig_cap) +
    xlab(xlab.stop) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    theme(legend.position = "none")

print(graph)
```

Figure `r fig_nums(cap, display = "num")` is depicting the mean INR value before and after bivalirudin cessation (represented by the time point 0 on the x-axis). The blue line represents the smoothed mean INR value throughout the time period. The black line represents the linear mean INR value, split for values before cessation and after cessation. The colored lines and points represent individual patient INR values. Data from patients who started warfarin during the first 24 hours after bivalirudin initiation were excluded.


```{r echo=FALSE}
cap <- "dual_bival"
fig_cap <- fig_nums(cap)
```

### `r fig_nums(cap, display = "cite")`
```{r dual_bival}
graph.data <- analyze.labs.serial %>%
    filter(lab == "inr" | lab == "ptt",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start + diff(from),
           lab.datetime <= bival.start + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE)) 

graph.inr1 <- filter(graph.data, lab == "inr") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("A. INR and bivalirudin initiation") +
    xlab(NULL) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, labels = c("Before Warfarin", "On Warfarin")) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    labs(shape = "Lab values drawn: ") +
    theme(legend.position = "bottom")

tmp <- ggplot_gtable(ggplot_build(graph.inr1))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]

graph.inr1 <- graph.inr1 + theme(legend.position = "none")

graph.ptt1 <- filter(graph.data, lab == "ptt") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("C. aPTT and bivalirudin initiation") +
    xlab(xlab.start) +
    ylab(ylab.ptt) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes) +
    coord_cartesian(xlim = xlim, ylim = ylim.ptt) +
    theme(legend.position = "none")

graph.data <- analyze.labs.serial %>%
    filter(lab == "inr" | lab == "ptt",
           last(lab.datetime) > bival.stop,
           lab.datetime >= bival.stop + diff(from),
           lab.datetime <= bival.stop + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.stop, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE))

graph.inr2 <- filter(graph.data, lab == "inr") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("B. INR and bivalirudin cessation") +
    xlab(NULL) +
    ylab(NULL) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    theme(legend.position = "none")

graph.ptt2 <- filter(graph.data, lab == "ptt") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("D. aPTT and bivalirudin cessation") +
    xlab(xlab.stop) +
    ylab(NULL) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.ptt) +
    theme(legend.position = "none")

layout <- rbind(c(1, 2), c(3, 4), c(5, 5))
grid.arrange(graph.inr1, graph.inr2, graph.ptt1, graph.ptt2, legend, nrow = 3, ncol = 2, top = fig_cap, layout_matrix = layout, heights = unit(c(2, 2, 0.5), c("in", "in", "in")))
```

```{r echo=FALSE}
cap <- "inr_chg_all"
fig_cap <- fig_nums(cap)
to = 10
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)
shapes <- c(16, 8)
colors <- c("red", "blue")
```

### `r fig_nums(cap, display = "cite")`
```{r inr_chg_all}
graph <- analyze.labs.serial %>%
    filter(lab == "inr",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start + diff(from),
           lab.datetime <= bival.start + diff(to),
           # lab.datetime <= warf.start,
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given, color = bival.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle(fig_cap) +
    xlab(xlab.start) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = colors, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) 

print(graph)
```

```{r echo=FALSE}
cap <- "ptt_chg_all"
fig_cap <- fig_nums(cap)
to <- 5
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)
```

### `r fig_nums(cap, display = "cite")`
```{r ptt_chg_all}
graph <- analyze.labs.serial %>%
    filter(lab == "ptt",
           last(lab.datetime) > bival.stop,
           lab.datetime >= bival.stop + diff(from),
           lab.datetime <= bival.stop + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.stop, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given, color = bival.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle(fig_cap) +
    xlab(xlab.stop) +
    ylab(ylab.ptt) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = colors, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.ptt) 

print(graph)
```

```{r echo=FALSE}
cap <- "inr_warfarin"
fig_cap <- fig_nums(cap)
from <- -7
to <- 10
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)
```

### `r fig_nums(cap, display = "cite")`
```{r inr_warfarin}
graph <- analyze.labs.serial %>%
    filter(lab == "inr",
           last(lab.datetime) > bival.stop,
           lab.datetime >= warf.start + diff(from),
           lab.datetime <= warf.start + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(warf.diff = as.numeric(difftime(lab.datetime, warf.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) %>%
    ggplot(aes(x = warf.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given, color = bival.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle(fig_cap) +
    xlab(paste0("Time from warfarin initiation (", diff.units, ")")) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = colors, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) 

print(graph)
```

### Scatter Plot - PTT vs. INR
```{r}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), !is.na(ptt))

g <- ggplot(df, aes(x = ptt, y = inr)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

#### Linear Regression Model
```{r}
mod <- lm(inr ~ ptt, data = df)
summary(mod)
```

### Scatter Plot - PTT vs. Change in INR
```{r}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), !is.na(ptt)) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    mutate(inr.change = inr - inr.before,
           inr.change.pct = inr.change / inr.before)

g <- ggplot(df, aes(x = ptt, y = inr.change)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

#### PTT vs. % INR Change

```{r}
g <- ggplot(df, aes(x = ptt, y = inr.change.pct)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

#### Linear Regression Model
```{r}
mod <- lm(inr.change ~ ptt, data = df)
summary(mod)
```

```{r}
mod <- lm(inr.change.pct ~ ptt, data = df)
summary(mod)
```

#### PTT vs. Median INR Change per Patient
```{r}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), !is.na(ptt)) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    mutate(inr.change = inr - inr.before,
           inr.change.pct = inr.change / inr.before) %>%
    group_by(pie.id) %>%
    summarize(inr.change = median(inr.change),
              ptt = median(ptt))

g <- ggplot(df, aes(x = ptt, y = inr.change)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g

```

#### INR Change with Therapeutic aPTT
```{r}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), 
           !is.na(ptt),
           ptt >= 50,
           ptt <= 80) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    filter(!is.na(inr.before)) %>%
    mutate(inr.change = inr - inr.before,
           inr.change.pct = inr.change / inr.before)

library(tableone)
vars <- c("inr.before", "inr", "ptt", "inr.change")

tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE, nonnormal = c("inr.before", "inr", "ptt", "inr.change"))

knitr::kable(ptbl)
```

```{r}
tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl)
```

### INR Response to Bival
```{r}
df <- analyze.labs.serial %>%
    filter(lab == "inr",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start + diff(-1),
           # lab.datetime <= bival.start + diff(to),
           lab.datetime <= warf.start,
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) 
    
g <- ggplot(df, aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), color = bival.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    # ggtitle(fig_cap) +
    # xlab(xlab.start) +
    # ylab(ylab.inr) +
    scale_x_continuous(breaks = seq(-1, 10, by = 1)) +
    # scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = c("red", "blue"), limits = c(FALSE, TRUE)) +
    coord_cartesian(xlim = c(-1, 10), ylim = c(1, 3.5)) 

g
```

## Post-Hoc Analysis

#### Change in INR at time of first therapeutic PTT with an INR
```{r}
ptt <- analyze.labs.serial %>%
    filter(lab == "ptt",
           result >= 50,
           result <= 80,
           lab.datetime >= bival.start,
           lab.datetime <= warf.start) %>%
    select(pie.id, lab.datetime, bival.start, ptt = result)

inr <- analyze.labs.serial %>%
    filter(lab == "inr",
           lab.datetime >= bival.start,
           lab.datetime <= warf.start) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    filter(!is.na(inr.before)) %>%
    select(pie.id, lab.datetime, inr = result, inr.before)

df <- inner_join(ptt, inr, by = c("pie.id", "lab.datetime")) %>%
    mutate(duration = difftime(lab.datetime, bival.start, units = "hours"),
           inr.change = inr - inr.before) %>%
    arrange(pie.id, lab.datetime) %>%
    group_by(pie.id) %>%
    summarize_all(funs(first))

# n.pts <- distinct(df, pie.id)

g <- ggplot(df, aes(x = ptt, y = inr.change)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

```{r}
library(tableone)
vars <- c("inr.before", "inr", "ptt", "inr.change")

tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE, nonnormal = c("inr.before", "inr", "ptt", "inr.change"))

knitr::kable(ptbl)
summary(tbl)
```

```{r}
tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl)
```

#### Fig 1 Revised
```{r}
results <- df %>%
    rename(inr1 = inr.before,
           inr2 = inr) %>%
    group_by(pie.id) %>%
    gather(period, inr, inr1, inr2)

cols <- colorRampPalette(brewer.pal(8, "Set1"))
num.cols <- nrow(distinct(results, pie.id))

graph <- ggplot(data = results, aes(x = period, y = inr, group = factor(pie.id))) +
    geom_line(size = 1, aes(colour = pie.id)) +
    geom_point(size = 5, pch = 21, fill = "salmon", alpha = 0.5) +
    # ggtitle(fig_cap) +
    xlab(NULL) +
    ylab("INR") +
    scale_x_discrete(labels = c("Baseline", "First Therapeutic aPTT\n with INR"), expand = c(0.25, 0.25)) +
    scale_color_manual(values = cols(num.cols)) +
    # theme_bw() +
    theme(legend.position = "none")
    # theme(legend.position = "none", plot.title = element_text(size = 20), 
    #       axis.title = element_text(size = 18), axis.text = element_text(size = 16))

print(graph)

```

