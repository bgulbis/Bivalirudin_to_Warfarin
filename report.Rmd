---
title: "Evaluation of Bivalirudin's Effect on the INR"
author: "Andrea Fetea, Brian Gulbis, Andrea C. Hall"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document: 
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_float: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r setup, include=FALSE}
# library(BGTools)
library(tidyverse)
library(lubridate)
library(forcats)
library(grid)
library(gridExtra)
library(RColorBrewer)
library(tableone)
library(themebg)

tmp <- dirr::get_rds("Analysis")
```

## Results

### Baseline Characteristics
```{r demographics}
df <- analyze.demographics %>%
    select(Age = age,
           Sex = sex,
           Race = race,
           `Length of Stay` = los,
           `Discharge Disposition` = disposition)

vars <- names(df)
fvars <- names(df)[c(2, 3, 5)]

tbl <- CreateTableOne(vars = vars, data = df, factorVars = fvars)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Demographics")

ptbl <- print(tbl$ContTable, printToggle = FALSE, nonnormal = names(df)[c(1, 4)])

knitr::kable(ptbl, caption = "Demographics (Medians)")
```

```{r pmh}
vars <- names(analyze.diagnosis[-1])

tbl <- CreateTableOne(vars = vars, data = analyze.diagnosis, factorVars = vars)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Comorbidities")
```

```{r indications}
df <- analyze.indications %>%
    # group_by(pie.id) %>%
    # mutate(multiple = sum(afib, dvt, pe, other, valve) > 1) %>%
    ungroup() %>%
    select(`Atrial Fibrillation` = afib,
           `Deep Vein Thrombosis` = dvt,
           `Pulmonary Embolism` = pe,
           `Valvular Heart Disease` = valve,
           Other = other,
           `Venous Thromboembolism` = vte,
           `Multiple Indications` = multiple)

vars <- names(df)

tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Anticoagulation Indications")
```

```{r labs}
df <- analyze.labs %>%
    mutate(epsn = elisa == "Positive" & sra == FALSE,
           epsna = elisa == "Positive" & is.na(sra)) %>%
    select(`Serum Creatinine` = scr,
           `Creatinine Clearance` = crcl,
           AST = ast,
           ALT = alt,
           `Total Bili` = t.bili, 
           `Heparin ELISA` = elisa,
           `ELISA pos / SRA pos` = sra,
           `ELISA pos / SRA neg` = epsn,
           `ELISA pos / no SRA` = epsna)

vars <- names(df)
# fvars <- "elisa"

tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Baseline Labs")

ptbl <- print(tbl$ContTable, printToggle = FALSE, nonnormal = vars)

knitr::kable(ptbl, caption = "Baseline Labs (Medians)")
```

```{r meds}
analyze.meds %>%
    select(-pie.id) %>%
    gather(variable, value) %>%
    dmap_at("variable", fct_inorder) %>%
    group_by(variable) %>%
    summarize_at("value", funs(n = sum(.), total = sum(!is.na(.)), `n/a` = sum(is.na(.))), na.rm = TRUE) %>%
    mutate(`%` = n / total * 100) %>%
    select(variable, n, `%`, `n/a`) %>%
    knitr::kable(digits = 2, caption = "Medications Administered During Hospitalization")
```

### Bivalirudin Data

```{r bival}
analyze.bival %>%
    inner_join(analyze.demographics[c("pie.id", "bival.prior.warf", "overlap", "proc.48hrs")], by = "pie.id") %>%
    select(`Starting Rate` = first.rate,
           `Final Rate` = last.rate,
           `Minimum Rate` = min.rate,
           `Maximum Rate` = max.rate,
           `Drip Rate AUC` = auc.rate,
           `Drip Duration` = bival.duration,
           `Time-Weighted Average Rate` = time.wt.rate,
           `Drip Duration Prior to Warfarin` = bival.prior.warf,
           `Days Overlap with Warfarin` = overlap,
           `Procedure Prior to Bivalirudin` = proc.48hrs) %>%
    gather(variable, value) %>%
    dmap_at("variable", fct_inorder) %>%
    group_by(variable) %>%
    summarize_at("value", funs(n = sum(!is.na(.)), min, max, mean, sd, median, `25th` = quantile(., probs = 0.25), `75th` = quantile(., probs = 0.75), `n/a` = sum(is.na(.))), na.rm = TRUE) %>%
    knitr::kable(digits = 2, caption = "Bivalirudin Infusion Information")
```

```{r percent_tx}
analyze.ptt.perc %>%
    select(`Within Goal PTT Range` = perc.time.goal,
           `Below Goal PTT Range` = perc.time.low,
           `Above Goal PTT Range` = perc.time.high) %>%
    gather(variable, value) %>%
    dmap_at("variable", fct_inorder) %>%
    group_by(variable) %>%
    summarize_at("value", funs(n = sum(!is.na(.)), min, max, mean, sd, median, `25th` = quantile(., probs = 0.25), `75th` = quantile(., probs = 0.75), `n/a` = sum(is.na(.))), na.rm = TRUE) %>%
    knitr::kable(digits = 2, caption = "Percent of Time PTT Values were In-Range")
```

### Primary Endpoints

```{r, fig.cap="Distribution of INR values at key time points relative to bivalirudin initiation and cessation"}
analyze.coags %>%
    select(inr.before, inr.txptt, inr.before.stop, inr.after.stop) %>%
    gather(key, inr, inr.before, inr.txptt, inr.before.stop, inr.after.stop) %>%
    filter(!is.na(inr)) %>%
    dmap_at("key", fct_inorder) %>%
    ggplot(aes(x = key, y = inr)) +
    geom_hline(yintercept = 2, color = "light gray") +
    geom_hline(yintercept = 3, color = "light gray") +
    geom_boxplot() +
    scale_x_discrete("Time point relative to bivalirudin", labels = c("Before Initiation", "After Initiation", "Before Cessation", "After Cessation")) +
    ylab("INR") +
    theme_bg(xticks = FALSE)
```

```{r}
analyze.coags %>%
    select(`INR at Baseline` = inr.before,
           `PTT at Baseline` = ptt.before,
           `INR at First Therapeutic PTT` = inr.txptt,
           `First Therapeutic PTT` = ptt.tx,
           `Time to First Therapeutic PTT` = inr.txptt.time,
           `Change in INR at First Therapeutic PTT` = inr.change) %>%
    gather(variable, value) %>%
    dmap_at("variable", fct_inorder) %>%
    group_by(variable) %>%
    summarize_at("value", funs(n = sum(!is.na(.)), min, max, mean, sd, median, `25th` = quantile(., probs = 0.25), `75th` = quantile(., probs = 0.75), `n/a` = sum(is.na(.))), na.rm = TRUE) %>%
    knitr::kable(digits = 2, caption = "Primary endpoint and related data")
```


### Secondary Endpoints
```{r}
analyze.coags %>%
    select(`INR at 12-Hours` = inr.12hr,
           `PTT at 12-Hours` = ptt.12hr,
           `Change in INR at 12-Hours` = inr.change.12hr,
           `INR at 24-Hours` = inr.24hr,
           `PTT at 24-Hours` = ptt.24hr,
           `Change in INR at 24-Hours` = inr.change.24hr) %>%
    gather(variable, value) %>%
    dmap_at("variable", fct_inorder) %>%
    group_by(variable) %>%
    summarize_at("value", funs(n = sum(!is.na(.)), min, max, mean, sd, median, `25th` = quantile(., probs = 0.25), `75th` = quantile(., probs = 0.75), `n/a` = sum(is.na(.))), na.rm = TRUE) %>%
    knitr::kable(digits = 2, caption = "INR Change at 12- and 24-Hours")
```

```{r}
analyze.coags %>%
    select(`INR Prior to Cessation` = inr.before.stop,
           `PTT Prior to Cessation` = ptt.before.stop,
           `INR After Cessation` = inr.after.stop,
           `PTT After Cessation` = ptt.after.stop,
           `Change in INR at Cessation` = inr.change.stop) %>%
    gather(variable, value) %>%
    dmap_at("variable", fct_inorder) %>%
    group_by(variable) %>%
    summarize_at("value", funs(n = sum(!is.na(.)), min, max, mean, sd, median, `25th` = quantile(., probs = 0.25), `75th` = quantile(., probs = 0.75), `n/a` = sum(is.na(.))), na.rm = TRUE) %>%
    knitr::kable(digits = 2, caption = "INR Change at Bivalirudin Cessation")
```

### Safety Endpoints
```{r events}
vars <- names(analyze.bleed[-1])
fvars <- c("major.bleed", "minor.bleed", "new.thrombosis")

tbl <- CreateTableOne(vars = vars, data = analyze.bleed, factorVars = fvars)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Bleeding and Thrombosis")
```

```{r prbc}
vars <- names(analyze.prbc[-1])

tbl <- CreateTableOne(vars = vars, data = analyze.prbc, factorVars = vars)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Blood Product Administration")
```

```{r reversal}
vars <- names(analyze.reversal[-1])

tbl <- CreateTableOne(vars = vars, data = analyze.reversal, factorVars = vars)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Reversal Agent Administration")
```

## Exploratory Figures

```{r plot_params}
diff.units <- "days"
diff <- if(diff.units == "days") days else if (diff.units == "hours") hours
from = -2
to = 3
by = 1
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)
xlab.start <- paste0("Time from bivalirudin initiation (", diff.units, ")")
xlab.stop <- paste0("Time from bivalirudin cessation (", diff.units, ")")
ylab.inr <- "INR"
ylab.ptt <- "aPTT (seconds)"
ylim.inr <- c(1, 3.5)
ylim.ptt <- c(45, 85)
shapes <- c(20, 21)
shapes.limits <- c(FALSE, TRUE)
graph.alpha <- 0.5
```


### INR Values
```{r inr_tx_ptt, fig.cap="INR Value at Baseline and Time of First Therapeutic aPTT - 14 Patients"}
results <- select(analyze.coags, pie.id, inr.before, inr.txptt) %>%
    rename(inr1 = inr.before,
           inr2 = inr.txptt) %>%
    group_by(pie.id) %>%
    filter(!is.na(inr1),
           !is.na(inr2)) %>%
    gather(period, inr, inr1, inr2)

cols <- colorRampPalette(brewer.pal(8, "Set1"))
num.cols <- nrow(select(results, pie.id) %>% distinct)

graph <- ggplot(data = results, aes(x = period, y = inr, group = factor(pie.id))) +
    geom_line(size = 1, aes(colour = pie.id)) +
    geom_point(size = 5, pch = 21, fill = "salmon", alpha = 0.5) +
    # ggtitle(fig_cap) +
    xlab(NULL) +
    ylab(ylab.inr) +
    scale_x_discrete(labels = c("Baseline", "First Therapeutic aPTT"), expand = c(0.25, 0.25)) +
    scale_color_manual(values = cols(num.cols)) +
    # theme_bw() +
    theme(legend.position = "none")
    # theme(legend.position = "none", plot.title = element_text(size = 20), 
    #       axis.title = element_text(size = 18), axis.text = element_text(size = 16))

print(graph)
```

This figure was limited to only those patients who had an INR drawn at the same time as their first therapeutic PTT

```{r inr_bival_stop, fig.cap="INR Value Prior to and 4 to 8 hours After Bivalirudin Cessation"}
results <- select(analyze.coags, pie.id, inr.before.stop, inr.after.stop) %>%
    rename(inr1 = inr.before.stop,
           inr2 = inr.after.stop) %>%
    group_by(pie.id) %>%
    filter(!is.na(inr1),
           !is.na(inr2)) %>%
    gather(period, inr, inr1, inr2)

graph <- ggplot(data = results, aes(x = period, y = inr, group=factor(pie.id))) +
    geom_line(size = 1, aes(colour = pie.id)) +
    geom_point(size = 5, pch = 21, fill = "salmon", alpha = 0.5) +
    # ggtitle(fig_cap) +
    xlab(NULL) +
    ylab(ylab.inr) +
    scale_x_discrete(labels = c("Prior to Cessation", "After Cessation"), expand = c(0.25, 0.25)) +
    # theme_bw() +
    theme(legend.position = "none")
    # theme(legend.position = "none", plot.title = element_text(size = 20), 
    #       axis.title = element_text(size = 18), axis.text = element_text(size = 16))

print(graph)
```

### Change in INR

```{r inr_chg_bival_start, fig.cap="Change in INR values at bivalirudin initiation"}
analyze.labs.serial %>%
    filter(lab == "inr",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start + days(-2),
           lab.datetime <= bival.start + days(5),
           warf.start >= bival.start + days(1),
           lab.datetime <= warf.start) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = "days"))) %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
    geom_point(shape = 1) +
    # geom_line(alpha = graph.alpha) +
    geom_smooth(aes(group = NULL), color = "blue") +
    # geom_smooth(aes(group = bival.diff <= 0), method = "lm", color = "black") +
    # ggtitle(fig_cap) +
    xlab("Time on bivalirudin (days)") +
    ylab("INR") +
    # scale_x_continuous(breaks = x.breaks) +
    # coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    theme_bg()
    # theme(legend.position = "none")
```

This figure is depicting the mean INR value before and after bivalirudin initation (represented by the time point 0 on the x-axis). The blue line represents the smoothed mean INR value throughout the time period. The black line represents the linear mean INR value, split for values before initiation and after initiation. The colored lines and points represent individual patient INR values. Data from patients who started warfarin during the first 24 hours after bivalirudin initiation were excluded, so the INR increase during the first 24 hours of bivalirudin infusion should be the result of bivalirudin.

```{r inr_chg_bival_stop, fig.cap="Change in INR values at bivalirudin cessation"}
graph <- analyze.labs.serial %>%
    filter(lab == "inr",
           last(lab.datetime) > bival.stop,
           lab.datetime >= bival.stop + diff(from),
           lab.datetime <= bival.stop + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.stop, units = diff.units))) %>%
    ggplot(aes(x = bival.diff, y = result, color = pie.id)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(alpha = graph.alpha) +
    geom_line(alpha = graph.alpha) +
    geom_smooth(aes(group = NULL), color = "blue", se = FALSE) +
    geom_smooth(aes(group = bival.diff <= 0), method = "lm", color = "black") +
    # ggtitle(fig_cap) +
    xlab(xlab.stop) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    theme(legend.position = "none")

print(graph)
```

This figure is depicting the mean INR value before and after bivalirudin cessation (represented by the time point 0 on the x-axis). The blue line represents the smoothed mean INR value throughout the time period. The black line represents the linear mean INR value, split for values before cessation and after cessation. The colored lines and points represent individual patient INR values. Data from patients who started warfarin during the first 24 hours after bivalirudin initiation were excluded.

```{r dual_bival, fig.cap="Change in INR and aPTT values at bivalirudin initiation and cessation"}
graph.data <- analyze.labs.serial %>%
    filter(lab == "inr" | lab == "ptt",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start + diff(from),
           lab.datetime <= bival.start + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE)) 

graph.inr1 <- filter(graph.data, lab == "inr") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("A. INR and bivalirudin initiation") +
    xlab(NULL) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, labels = c("Before Warfarin", "On Warfarin")) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    labs(shape = "Lab values drawn: ") +
    theme(legend.position = "bottom")

tmp <- ggplot_gtable(ggplot_build(graph.inr1))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]

graph.inr1 <- graph.inr1 + theme(legend.position = "none")

graph.ptt1 <- filter(graph.data, lab == "ptt") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("C. aPTT and bivalirudin initiation") +
    xlab(xlab.start) +
    ylab(ylab.ptt) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes) +
    coord_cartesian(xlim = xlim, ylim = ylim.ptt) +
    theme(legend.position = "none")

graph.data <- analyze.labs.serial %>%
    filter(lab == "inr" | lab == "ptt",
           last(lab.datetime) > bival.stop,
           lab.datetime >= bival.stop + diff(from),
           lab.datetime <= bival.stop + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.stop, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE))

graph.inr2 <- filter(graph.data, lab == "inr") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("B. INR and bivalirudin cessation") +
    xlab(NULL) +
    ylab(NULL) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) +
    theme(legend.position = "none")

graph.ptt2 <- filter(graph.data, lab == "ptt") %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    ggtitle("D. aPTT and bivalirudin cessation") +
    xlab(xlab.stop) +
    ylab(NULL) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.ptt) +
    theme(legend.position = "none")

layout <- rbind(c(1, 2), c(3, 4), c(5, 5))
grid.arrange(graph.inr1, graph.inr2, graph.ptt1, graph.ptt2, legend, nrow = 3, ncol = 2, layout_matrix = layout, heights = unit(c(2, 2, 0.5), c("in", "in", "in")))
```

```{r}
baseline <- analyze.labs.serial %>%
    filter(lab %in% c("inr", "ptt"),
           lab.datetime <= bival.start) %>%
    group_by(pie.id, lab) %>%
    arrange(lab.datetime) %>%
    summarize(baseline = last(result),
              baseline_datetime = last(lab.datetime))

dual_data <- analyze.labs.serial %>%
    left_join(baseline, by = c("pie.id", "lab")) %>%
    filter(lab %in% c("inr", "ptt"),
           # first(lab.datetime) > bival.start,
           # last(lab.datetime) > bival.start,
           # lab.datetime >= bival.start + diff(from),
           # lab.datetime > bival.start,
           lab.datetime >= baseline_datetime,
           lab.datetime <= bival.start + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE)) %>%
    group_by(pie.id, lab) %>%
    mutate(lab_change = result / first(result) * 100)

dual_data %>%
    filter(!warf.given) %>%
    ggplot(aes(x = bival.diff, y = lab_change, color = lab)) +
    # geom_line(aes(linetype = lab))
    geom_point(alpha = 0.4) +
    geom_smooth() +
    coord_cartesian(ylim = c(0, 250))

```


```{r inr_chg_all, fig.cap="Change in INR relative to bivalirudin initiation over 10 days"}
to = 10
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)
shapes <- c(16, 8)
colors <- c("red", "blue")

graph <- analyze.labs.serial %>%
    filter(lab == "inr",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start + diff(from),
           lab.datetime <= bival.start + diff(to),
           # lab.datetime <= warf.start,
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given, color = bival.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    # ggtitle(fig_cap) +
    xlab(xlab.start) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = colors, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) 

print(graph)
```

```{r fig.cap="Change in INR relative to bivalirudin initiation Prior to warfarin"}
df <- analyze.labs.serial %>%
    filter(lab == "inr",
           first(lab.datetime) < bival.start,
           last(lab.datetime) > bival.start,
           lab.datetime >= bival.start - days(1),
           # lab.datetime <= bival.start + diff(to),
           lab.datetime <= warf.start,
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.start, units = "days")),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) 
    
g <- ggplot(df, aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), color = bival.given), alpha = 0.5) +
    geom_smooth(color = "black") +
    # ggtitle(fig_cap) +
    # xlab(xlab.start) +
    # ylab(ylab.inr) +
    scale_x_continuous(breaks = seq(-1, 5, by = 1), limits = c(-1, 5)) +
    # xlim = c(-1, 5) +
    # scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = c("red", "blue")) +
    coord_cartesian(ylim = c(1, 3.5)) 

g
```

```{r inr_warfarin, fig.cap="Change in INR relative to warfarin initiation"}
from <- -7
to <- 10
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)

graph <- analyze.labs.serial %>%
    filter(lab == "inr",
           last(lab.datetime) > bival.stop,
           lab.datetime >= warf.start + diff(from),
           lab.datetime <= warf.start + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(warf.diff = as.numeric(difftime(lab.datetime, warf.start, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) %>%
    ggplot(aes(x = warf.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given, color = bival.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    # ggtitle(fig_cap) +
    xlab(paste0("Time from warfarin initiation (", diff.units, ")")) +
    ylab(ylab.inr) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = colors, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.inr) 

print(graph)
```

### Change in PTT
```{r ptt_chg_all, fig.cap="Change in aPTT relative to bivalirudin cessation"}
to <- 5
xlim <- c(from, to)
x.breaks <- seq(from, to, by = by)

graph <- analyze.labs.serial %>%
    filter(lab == "ptt",
           last(lab.datetime) > bival.stop,
           lab.datetime >= bival.stop + diff(from),
           lab.datetime <= bival.stop + diff(to),
           warf.start >= bival.start + days(1)) %>%
    mutate(bival.diff = as.numeric(difftime(lab.datetime, bival.stop, units = diff.units)),
           warf.given = ifelse(lab.datetime >= warf.start, TRUE, FALSE),
           bival.given = ifelse(lab.datetime >= bival.start & lab.datetime <= bival.stop, TRUE, FALSE)) %>%
    ggplot(aes(x = bival.diff, y = result)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(group = factor(pie.id), shape = warf.given, color = bival.given), alpha = graph.alpha) +
    geom_smooth(color = "black") +
    # ggtitle(fig_cap) +
    xlab(xlab.stop) +
    ylab(ylab.ptt) +
    scale_x_continuous(breaks = x.breaks) +
    scale_shape_manual(values = shapes, limits = shapes.limits) +
    scale_color_manual(values = colors, limits = shapes.limits) +
    coord_cartesian(xlim = xlim, ylim = ylim.ptt) 

print(graph)
```

### Scatter Plots
```{r fig.cap="PTT vs. INR"}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), !is.na(ptt))

g <- ggplot(df, aes(x = ptt, y = inr)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

```{r}
mod <- lm(inr ~ ptt, data = df)
summary(mod)
```

```{r fig.cap="PTT vs. Change in INR"}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), !is.na(ptt)) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    mutate(inr.change = inr - inr.before,
           inr.change.pct = inr.change / inr.before)

g <- ggplot(df, aes(x = ptt, y = inr.change)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

```{r}
vars <- c("inr.before", "inr", "ptt", "inr.change")

tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl)

ptbl <- print(tbl, printToggle = FALSE, nonnormal = c("inr.before", "inr", "ptt", "inr.change"))

knitr::kable(ptbl)

```

```{r}
mod <- lm(inr.change ~ ptt, data = df)
summary(mod)
```

```{r fig.cap="PTT vs. Percent INR Change"}
g <- ggplot(df, aes(x = ptt, y = inr.change.pct)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

```{r}
mod <- lm(inr.change.pct ~ ptt, data = df)
summary(mod)
```

```{r fig.cap="PTT vs. Median INR Change per Patient"}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), !is.na(ptt)) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    mutate(inr.change = inr - inr.before,
           inr.change.pct = inr.change / inr.before) %>%
    group_by(pie.id) %>%
    summarize(inr.change = median(inr.change),
              ptt = median(ptt))

g <- ggplot(df, aes(x = ptt, y = inr.change)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g

```

```{r fig.cap="INR Change with Therapeutic aPTT"}
df <- filter(analyze.labs.serial, lab == "inr" | lab == "ptt",
             lab.datetime >= bival.start,
             lab.datetime <= warf.start) %>%
    select(pie.id:result) %>%
    group_by(pie.id, lab.datetime) %>%
    spread(lab, result) %>%
    filter(!is.na(inr), 
           !is.na(ptt),
           ptt >= 50,
           ptt <= 80) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    filter(!is.na(inr.before)) %>%
    mutate(inr.change = inr - inr.before,
           inr.change.pct = inr.change / inr.before)

library(tableone)
vars <- c("inr.before", "inr", "ptt", "inr.change")

tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE, nonnormal = c("inr.before", "inr", "ptt", "inr.change"))

knitr::kable(ptbl)
```

```{r}
tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl)
```

### Post-Hoc Analysis

```{r fig.cap="Change in INR at time of therapeutic PTT with an INR"}
ptt <- analyze.labs.serial %>%
    filter(lab == "ptt",
           result >= 50,
           result <= 80,
           lab.datetime >= bival.start,
           lab.datetime <= warf.start,
           lab.datetime <= bival.stop) %>%
    select(pie.id, lab.datetime, bival.start, ptt = result)

inr <- analyze.labs.serial %>%
    filter(lab == "inr",
           lab.datetime >= bival.start,
           lab.datetime <= warf.start) %>%
    inner_join(analyze.coags[c("pie.id", "inr.before")], by = "pie.id") %>%
    filter(!is.na(inr.before)) %>%
    select(pie.id, lab.datetime, inr = result, inr.before)

df <- inner_join(ptt, inr, by = c("pie.id", "lab.datetime")) %>%
    mutate(duration = as.numeric(difftime(lab.datetime, bival.start, units = "hours")),
           inr.change = inr - inr.before) %>%
    arrange(pie.id, lab.datetime) %>%
    group_by(pie.id) #%>%
    # summarize_all(funs(first))

# n.pts <- distinct(df, pie.id)

g <- ggplot(df, aes(x = ptt, y = inr.change)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

```{r}
vars <- c("inr.before", "inr", "ptt", "inr.change", "duration")

tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE)

knitr::kable(ptbl, caption = "Values for Change in INR at time of Therapeutic PTT")
# summary(tbl)
```

```{r}
tbl <- CreateTableOne(vars = vars, data = df)
ptbl <- print(tbl, printToggle = FALSE, nonnormal = c("inr.before", "inr", "ptt", "inr.change", "duration"))
knitr::kable(ptbl)
```

```{r fig.cap="Change in INR vs. Time from Bivalirudin Onset"}
g <- ggplot(df, aes(x = duration, y = inr.change, color = ptt)) +
    geom_point() +
    geom_smooth(method = "lm") 

g
```

```{r fig.cap="Change in INR vs. Time from Bivalirudin Onset over first 5 days"}
g <- ggplot(df, aes(x = duration, y = inr.change, color = ptt)) +
    geom_point() +
    geom_smooth(method = "lm") +
    xlim(c(0, 24*5)) 

g
```

```{r fig.cap="Change in first INR at time of first therapeutic PTT with an INR"}
df <- df %>%
    summarize_all(funs(first))

g <- ggplot(df, aes(x = ptt, y = inr.change)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm") +
    theme(legend.position = "none")

g
```

```{r fig.cap="INR Value at Baseline and Time of First Therapeutic aPTT with INR - 26 Patients"}
results <- df %>%
    rename(inr1 = inr.before,
           inr2 = inr) %>%
    group_by(pie.id) %>%
    gather(period, inr, inr1, inr2)

cols <- colorRampPalette(brewer.pal(8, "Set1"))
num.cols <- nrow(distinct(results, pie.id))

graph <- ggplot(data = results, aes(x = period, y = inr, group = factor(pie.id))) +
    geom_line(size = 1, aes(colour = pie.id)) +
    geom_point(size = 5, pch = 21, fill = "salmon", alpha = 0.5) +
    # ggtitle(fig_cap) +
    xlab(NULL) +
    ylab("INR") +
    scale_x_discrete(labels = c("Baseline", "First Therapeutic aPTT\n with INR"), expand = c(0.25, 0.25)) +
    scale_color_manual(values = cols(num.cols)) +
    # theme_bw() +
    theme(legend.position = "none")
    # theme(legend.position = "none", plot.title = element_text(size = 20), 
    #       axis.title = element_text(size = 18), axis.text = element_text(size = 16))

print(graph)

```

The above figure is the same as the very first figure, except the INR at the time of the first therapeutic PTT with an INR was used.
